@istest
public class Test_SingleCart_QuoteBackup1 {
    
    testMethod public static void test(){
        User salesManager;         
        Id pricebookId;
        Id stdPriceBookRecId = Test.getStandardPricebookId();
        System.runAs(new User(Id = Userinfo.getUserId())){
            salesManager = Test_DataFactory.createSalesManagerUsers(1)[0];
            salesManager.Bypass_VR__c = true;
            insert salesManager;
        }
        System.runAs(salesManager){   
            vlocity_cmt__ObjectClass__c objClass = new vlocity_cmt__ObjectClass__c();
            objClass.Name = 'Mobile Offer Specification';    
            objClass.vlocity_cmt__IsActive__c = True;
            objClass.vlocity_cmt__ObjectApiName__c = 'Product2';
            insert objClass;
            
            Product2 prod1 = Test_DataFactory.createProducts(1)[0];
            prod1.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod1.ProductCode = 'MOB_ALL_IN';
            prod1.Name = 'Allinplus';
            insert prod1;
            Product2 prod2 = Test_DataFactory.createProducts(1)[0];
            prod2.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod2.ProductCode = 'MOB_SURF_BAS';
            prod2.Name = 'jobmobilbas';
            insert prod2;
            Product2 prod21 = Test_DataFactory.createProducts(1)[0];
            prod21.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod21.ProductCode = 'MOB_SURF_0.5';
            prod21.Name = 'jobmobilbas_0.5gb';
            insert prod21;
            Product2 prod22 = Test_DataFactory.createProducts(1)[0];
            prod22.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod22.ProductCode = 'MOB_SURF_1';
            prod22.Name = 'jobmobilbas_1gb';
            insert prod22;
            Product2 prod3 = Test_DataFactory.createProducts(1)[0];
            prod3.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod3.ProductCode = 'MOB_OTHER_ADDON';
            prod3.Name = 'insurance';
            insert prod3;
            Product2 prod31 = Test_DataFactory.createProducts(1)[0];
            prod31.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod31.ProductCode = 'INSURANCE_1';
            prod31.Name = 'insurance_1';
            insert prod31;
            Product2 prod4 = Test_DataFactory.createProducts(1)[0];
            prod4.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod4.ProductCode = 'MOB_OTHER_TARIFF';
            prod4.Name = 'other';
            insert prod4;
            Product2 prod41 = Test_DataFactory.createProducts(1)[0];
            prod41.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod41.ProductCode = 'MOB_OTHER_TARIFF_1';
            prod41.Name = 'other1';
            insert prod41;
            Product2 prod42 = Test_DataFactory.createProducts(1)[0];
            prod42.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod42.ProductCode = 'MOB_OTHER_TARIFF_2';
            prod42.Name = 'other2';
            insert prod42;
            Product2 prod5 = Test_DataFactory.createProducts(1)[0];
            prod5.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod5.ProductCode = 'MOB_ADD_ON';
            prod5.Name = 'mobadon';
            insert prod5;            
            Product2 prod6 = Test_DataFactory.createProducts(1)[0];
            prod6.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod6.ProductCode = 'MOB_3GB';
            prod6.Name = 'job3gb';
            insert prod6;
            Product2 prod7 = Test_DataFactory.createProducts(1)[0];
            prod7.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod7.ProductCode = 'MOB_1GB';
            prod7.Name = 'job1gb';
            insert prod7;
            Product2 prod8 = Test_DataFactory.createProducts(1)[0];
            prod8.vlocity_cmt__ObjectTypeId__c = objClass.Id;
            prod8.ProductCode = 'MOB_2GB';
            prod8.Name = 'job2gb';
            insert prod8;
            
            set<String> pr = new set<String>();
                pr.add(prod1.Id);
                pr.add(prod2.id);
                pr.add(prod21.id);
                pr.add(prod22.id);
                pr.add(prod3.id);   
                pr.add(prod31.id);
                pr.add(prod4.id);
                pr.add(prod41.id);
                pr.add(prod42.id);
                pr.add(prod5.id);
                pr.add(prod6.id);
                pr.add(prod7.id);
                pr.add(prod8.id);
            
            pricebookId = stdPriceBookRecId ;
        
            Test.StartTest();
                Opportunity opp = new Opportunity();
                    opp.Name='opp1';
                    opp.CloseDate = System.today();
                    opp.StageName='Kvalificera';  
                    opp.Pricebook2Id=Test.getStandardPricebookId();
                    opp.TeliaSE_SharingSetting_Flag__c = false;
                insert opp;
                
        
                PricebookEntry objpricebookentry1 =new PricebookEntry();
                    objpricebookentry1.Product2ID = prod1.id;
                    objpricebookentry1.Pricebook2ID = stdPriceBookRecId;
                    objpricebookentry1.UnitPrice=23.50;
                    objpricebookentry1.UseStandardPrice=false;
                    objpricebookentry1.isActive=true;//Add this line
                insert objpricebookentry1;
                        
                Quote oldqut = new Quote();
                    oldqut.Name='Test Quote';
                    oldqut.status = 'Draft';
                    oldqut.opportunityId = opp.id;
                    oldqut.Pricebook2ID = stdPriceBookRecId;
                    oldqut.TeliaSE_Approval_Flag__c = False;
                insert oldqut;
                Quote oldqut1 = new Quote();
                    oldqut1.Name='Test Quote';
                    oldqut1.status = 'Cancelled';
                    oldqut1.opportunityId = opp.id;
                    oldqut1.Pricebook2ID = stdPriceBookRecId;
                    oldqut1.TeliaSE_Approval_Flag__c = False;
                insert oldqut1;
                List<QuoteLineItem> qlilist = new List<QuoteLineItem>();
                
                //all in plus
                QuoteLineItem qlibundle = new QuoteLineItem();
                    qlibundle.PricebookEntryId = objpricebookentry1.Id;
                    qlibundle.QuoteId = oldqut.id;
                    qlibundle.Product2Id = prod1.id;
                    qlibundle.vlocity_cmt__Product2Id__c = prod1.id;
                    qlibundle.vlocity_cmt__ProductHierarchyPath__c = prod1.id;
                    qlibundle.UnitPrice = 0;
                    qlibundle.Quantity = 1;
                insert qlibundle;
                    qlibundle.vlocity_cmt__RootItemId__c = qlibundle.Id;
                update qlibundle;
                // all in plus -- bas
                QuoteLineItem qlibas = new QuoteLineItem();
                    qlibas.PricebookEntryId = objpricebookentry1.Id;
                    qlibas.QuoteId = oldqut.id;
                    qlibas.Product2Id = prod2.id;
                    qlibas.vlocity_cmt__Product2Id__c = prod2.id;
                    qlibas.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod2.id;
                    qlibas.vlocity_cmt__RootItemId__c = qlibundle.Id;
                    qlibas.UnitPrice = 0;
                    qlibas.Quantity = 1;
                qlilist.add(qlibas);
                QuotelineItem qlibasaddon1 = new QuoteLineItem();
                    qlibasaddon1.PricebookEntryId = objpricebookentry1.Id;
                    qlibasaddon1.QuoteId = oldqut.id;
                    qlibasaddon1.Product2Id = prod21.id;
                    qlibasaddon1.vlocity_cmt__Product2Id__c = prod21.id;
                    qlibasaddon1.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod2.id+'<'+prod21.id;
                    qlibasaddon1.vlocity_cmt__RootItemId__c = qlibundle.Id;
                    qlibasaddon1.UnitPrice = 0;
                    qlibasaddon1.Quantity = 1;
                qlilist.add(qlibasaddon1);
                QuotelineItem qlibasaddon2 = new QuoteLineItem();
                    qlibasaddon2.PricebookEntryId = objpricebookentry1.Id;
                    qlibasaddon2.QuoteId = oldqut.id;
                    qlibasaddon2.Product2Id = prod22.id;
                    qlibasaddon2.vlocity_cmt__Product2Id__c = prod22.id;
                    qlibasaddon2.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod2.id+'<'+prod22.id;
                    qlibasaddon2.vlocity_cmt__RootItemId__c = qlibundle.Id;
                    qlibasaddon2.UnitPrice = 0;
                    qlibasaddon2.Quantity = 1;
                qlilist.add(qlibasaddon2);
                // all in plus -- 1gb
                QuotelineItem qli1gb = new QuoteLineItem();
                    qli1gb.PricebookEntryId = objpricebookentry1.Id;
                    qli1gb.QuoteId = oldqut.id;
                    qli1gb.Product2Id = prod7.id;
                    qli1gb.vlocity_cmt__Product2Id__c = prod7.id;
                    qli1gb.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod7.id;
                    qli1gb.vlocity_cmt__RootItemId__c = qlibundle.Id;
                    qli1gb.UnitPrice = 0;
                    qli1gb.Quantity = 1;
                qlilist.add(qli1gb);
                QuotelineItem qli1gbaddon1 = new QuoteLineItem();
                    qli1gbaddon1.PricebookEntryId = objpricebookentry1.Id;
                    qli1gbaddon1.QuoteId = oldqut.id;
                    qli1gbaddon1.Product2Id = prod31.id;
                    qli1gbaddon1.vlocity_cmt__Product2Id__c = prod31.id;
                    qli1gbaddon1.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod7.Id+'<'+prod3.id+'<'+prod31.Id;
                    qli1gbaddon1.vlocity_cmt__RootItemId__c = qlibundle.Id;
                    qli1gbaddon1.UnitPrice = 0;
                    qli1gbaddon1.Quantity = 1;
                qlilist.add(qli1gbaddon1);
                QuotelineItem qli1gbaddon2 = new QuoteLineItem();
                    qli1gbaddon2.PricebookEntryId = objpricebookentry1.Id;
                    qli1gbaddon2.QuoteId = oldqut.id;
                    qli1gbaddon2.Product2Id = prod41.id;
                    qli1gbaddon2.vlocity_cmt__Product2Id__c = prod41.id;
                    qli1gbaddon2.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod7.Id+'<'+prod4.id+'<'+prod41.Id;
                    qli1gbaddon2.vlocity_cmt__RootItemId__c = qlibundle.Id;
                    qli1gbaddon2.UnitPrice = 0;
                    qli1gbaddon2.Quantity = 1;
                qlilist.add(qli1gbaddon2);
                // all in plus -- 2gb
                QuotelineItem qli2gb = new QuoteLineItem();
                    qli2gb.PricebookEntryId = objpricebookentry1.Id;
                    qli2gb.QuoteId = oldqut.id;
                    qli2gb.Product2Id = prod8.id;
                    qli2gb.vlocity_cmt__Product2Id__c = prod8.id;
                    qli2gb.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod8.id;
                    qli2gb.vlocity_cmt__RootItemId__c = qlibundle.Id;
                    qli2gb.UnitPrice = 0;
                    qli2gb.Quantity = 1;
                qlilist.add(qli2gb);
                QuotelineItem qli2gbaddon1 = new QuoteLineItem();
                    qli2gbaddon1.PricebookEntryId = objpricebookentry1.Id;
                    qli2gbaddon1.QuoteId = oldqut.id;
                    qli2gbaddon1.Product2Id = prod42.id;
                    qli2gbaddon1.vlocity_cmt__Product2Id__c = prod42.id;
                    qli2gbaddon1.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod8.id+'<'+prod4.id+'<'+prod42.Id;
                    qli2gbaddon1.vlocity_cmt__RootItemId__c = qlibundle.Id;
                    qli2gbaddon1.UnitPrice = 0;
                    qli2gbaddon1.Quantity = 1;
                qlilist.add(qli2gbaddon1);
                QuotelineItem qli2gbaddon2 = new QuoteLineItem();
                    qli2gbaddon2.PricebookEntryId = objpricebookentry1.Id;
                    qli2gbaddon2.QuoteId = oldqut.id;
                    qli2gbaddon2.Product2Id = prod41.id;
                    qli2gbaddon2.vlocity_cmt__Product2Id__c = prod41.id;
                    qli2gbaddon2.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod8.id+'<'+prod4.id+'<'+prod41.Id;
                    qli2gbaddon2.vlocity_cmt__RootItemId__c = qlibundle.Id;
                    qli2gbaddon2.UnitPrice = 0;
                    qli2gbaddon2.Quantity = 1;
                qlilist.add(qli2gbaddon2);
                QuotelineItem qli2gbaddon3 = new QuoteLineItem();
                    qli2gbaddon3.PricebookEntryId = objpricebookentry1.Id;
                    qli2gbaddon3.QuoteId = oldqut.id;
                    qli2gbaddon3.Product2Id = prod31.id;
                    qli2gbaddon3.vlocity_cmt__Product2Id__c = prod31.id;
                    qli2gbaddon3.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod8.Id+'<'+prod3.id+'<'+prod31.Id;
                    qli2gbaddon3.vlocity_cmt__RootItemId__c = qlibundle.Id;
                    qli2gbaddon3.UnitPrice = 0;
                    qli2gbaddon3.Quantity = 1;
                qlilist.add(qli2gbaddon3);
                insert qlilist;
            
                //Master Quote
                Opportunity opp1 = new Opportunity();
                    opp1.Name='opp1';
                    opp1.CloseDate = System.today();
                    opp1.StageName='Kvalificera';  
                    opp1.Pricebook2Id=Test.getStandardPricebookId();
                    opp1.TeliaSE_SharingSetting_Flag__c = false;
                insert opp1;
                Quote masterQuote = new Quote();
                    masterQuote.Name='MasterQuote';
                    masterQuote.status = 'Draft';
                    masterQuote.opportunityId = opp1.id;
                    masterQuote.Pricebook2ID = stdPriceBookRecId;
                    masterQuote.TeliaSE_Approval_Flag__c = False;
                insert masterQuote;
                List<QuoteLineItem> qlilist1 = new List<QuoteLineItem>();
                //all in plus
                QuoteLineItem qliMbundle = new QuoteLineItem();
                    qliMbundle.PricebookEntryId = objpricebookentry1.Id;
                    qliMbundle.QuoteId = masterQuote.id;
                    qliMbundle.Product2Id = prod1.id;
                    qliMbundle.vlocity_cmt__Product2Id__c = prod1.id;
                    qliMbundle.vlocity_cmt__ProductHierarchyPath__c = prod1.id;
                    qliMbundle.UnitPrice = 0;
                    qliMbundle.Quantity = 1;
                insert qliMbundle;
                    qliMbundle.vlocity_cmt__RootItemId__c = qliMbundle.Id;
                update qliMbundle;
                //insurance
                QuotelineItem qlimaddon1 = new QuoteLineItem();
                    qlimaddon1.PricebookEntryId = objpricebookentry1.Id;
                    qlimaddon1.QuoteId = masterQuote.id;
                    qlimaddon1.Product2Id = prod3.id;
                    qlimaddon1.vlocity_cmt__Product2Id__c = prod3.id;
                    qlimaddon1.vlocity_cmt__ProductHierarchyPath__c = prod3.id;
                    qlimaddon1.UnitPrice = 0;
                    qlimaddon1.Quantity = 1;
                insert qlimaddon1;
                    qlimaddon1.vlocity_cmt__RootItemId__c = qlimaddon1.Id;
                update qlimaddon1;
            
                QuoteLineItem qlimaddon = new QuoteLineItem();
                    qlimaddon.PricebookEntryId = objpricebookentry1.Id;
                    qlimaddon.QuoteId = masterQuote.id;
                    qlimaddon.Product2Id = prod5.id;
                    qlimaddon.vlocity_cmt__Product2Id__c = prod5.id;
                    qlimaddon.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod5.id;
                    qlimaddon.vlocity_cmt__RootItemId__c = qliMbundle.Id;
                    qlimaddon.UnitPrice = 0;
                    qlimaddon.Quantity = 1;
                qlilist1.add(qlimaddon);
                //all in plus -- bas
                QuoteLineItem qlimbas = new QuoteLineItem();
                    qlimbas.PricebookEntryId = objpricebookentry1.Id;
                    qlimbas.QuoteId = masterQuote.id;
                    qlimbas.Product2Id = prod2.id;
                    qlimbas.vlocity_cmt__Product2Id__c = prod2.id;
                    qlimbas.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod2.id;
                    qlimbas.vlocity_cmt__RootItemId__c = qliMbundle.Id;
                    qlimbas.UnitPrice = 0;
                    qlimbas.Quantity = 1;
                qlilist1.add(qlimbas);
                QuotelineItem qlimbasaddon1 = new QuoteLineItem();
                    qlimbasaddon1.PricebookEntryId = objpricebookentry1.Id;
                    qlimbasaddon1.QuoteId = masterQuote.id;
                    qlimbasaddon1.Product2Id = prod21.id;
                    qlimbasaddon1.vlocity_cmt__Product2Id__c = prod21.id;            
                    qlimbasaddon1.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod2.id+'<'+prod21.id;
                    qlimbasaddon1.vlocity_cmt__RootItemId__c = qliMbundle.Id;
                    qlimbasaddon1.UnitPrice = 0;
                    qlimbasaddon1.Quantity = 1;
                qlilist1.add(qlimbasaddon1);
                QuotelineItem qlimbasaddon2 = new QuoteLineItem();
                    qlimbasaddon2.PricebookEntryId = objpricebookentry1.Id;
                    qlimbasaddon2.QuoteId = masterQuote.id;
                    qlimbasaddon2.Product2Id = prod22.id;
                    qlimbasaddon2.vlocity_cmt__Product2Id__c = prod22.id;    
                    qlimbasaddon2.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod2.id+'<'+prod22.id;
                    qlimbasaddon2.vlocity_cmt__RootItemId__c = qliMbundle.Id;
                    qlimbasaddon2.UnitPrice = 0;
                    qlimbasaddon2.Quantity = 1;
                qlilist1.add(qlimbasaddon2);
                //all in plus -- 1gb
                QuotelineItem qlim1gb = new QuoteLineItem();
                    qlim1gb.PricebookEntryId = objpricebookentry1.Id;
                    qlim1gb.QuoteId = masterQuote.id;
                    qlim1gb.Product2Id = prod7.id;
                    qlim1gb.vlocity_cmt__Product2Id__c = prod7.id; 
                    qlim1gb.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod7.id;
                    qlim1gb.vlocity_cmt__RootItemId__c = qliMbundle.Id;
                    qlim1gb.UnitPrice = 0;
                    qlim1gb.Quantity = 1;
                qlilist1.add(qlim1gb);
                //all in plus -- 2gb
                QuotelineItem qlim2gb = new QuoteLineItem();
                    qlim2gb.PricebookEntryId = objpricebookentry1.Id;
                    qlim2gb.QuoteId = masterQuote.id;
                    qlim2gb.Product2Id = prod8.id;
                    qlim2gb.vlocity_cmt__Product2Id__c = prod8.id;
                    qlim2gb.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod8.id;
                    qlim2gb.vlocity_cmt__RootItemId__c = qliMbundle.Id;
                    qlim2gb.UnitPrice = 0;
                    qlim2gb.Quantity = 1;
                qlilist1.add(qlim2gb);
                QuotelineItem qlim3gb = new QuoteLineItem();
                    qlim3gb.PricebookEntryId = objpricebookentry1.Id;
                    qlim3gb.QuoteId = masterQuote.id;
                    qlim3gb.Product2Id = prod6.id;
                    qlim3gb.vlocity_cmt__Product2Id__c = prod6.id;
                    qlim3gb.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod6.id;
                    qlim3gb.vlocity_cmt__RootItemId__c = qliMbundle.Id;
                    qlim3gb.UnitPrice = 0;
                    qlim3gb.Quantity = 1;
                qlilist1.add(qlim3gb);
                //insurance addon
                QuotelineItem qlimaddon11 = new QuoteLineItem();
                    qlimaddon11.PricebookEntryId = objpricebookentry1.Id;
                    qlimaddon11.QuoteId = masterQuote.id;
                    qlimaddon11.Product2Id = prod31.id;
                    qlimaddon11.vlocity_cmt__Product2Id__c = prod31.id;
                    qlimaddon11.vlocity_cmt__ProductHierarchyPath__c = prod3.id+'<'+prod31.id;
                    qlimaddon11.vlocity_cmt__RootItemId__c = qlimaddon1.Id;
                    qlimaddon11.UnitPrice = 0;
                    qlimaddon11.Quantity = 1;
                qlilist1.add(qlimaddon11);
                // all in plus -- trafikgifter
                QuotelineItem qlimaddon2 = new QuoteLineItem();
                    qlimaddon2.PricebookEntryId = objpricebookentry1.Id;
                    qlimaddon2.QuoteId = masterQuote.id;
                    qlimaddon2.Product2Id = prod4.id;
                    qlimaddon2.vlocity_cmt__Product2Id__c = prod4.id;
                    qlimaddon2.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod4.id;
                    qlimaddon2.vlocity_cmt__RootItemId__c = qliMbundle.Id;
                    qlimaddon2.UnitPrice = 0;
                    qlimaddon2.Quantity = 1;
                qlilist1.add(qlimaddon2);
                QuotelineItem qlimaddon21 = new QuoteLineItem();
                    qlimaddon21.PricebookEntryId = objpricebookentry1.Id;
                    qlimaddon21.QuoteId = masterQuote.id;
                    qlimaddon21.Product2Id = prod41.id;                 
                    qlimaddon21.vlocity_cmt__Product2Id__c = prod41.id;
                    qlimaddon21.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod4.id+'<'+prod41.Id;
                    qlimaddon21.vlocity_cmt__RootItemId__c = qliMbundle.Id;
                    qlimaddon21.UnitPrice = 0;
                    qlimaddon21.Quantity = 1;
                qlilist1.add(qlimaddon21);
                QuotelineItem qlimaddon22 = new QuoteLineItem();
                    qlimaddon22.PricebookEntryId = objpricebookentry1.Id;
                    qlimaddon22.QuoteId = masterQuote.id;
                    qlimaddon22.Product2Id = prod42.id;
                    qlimaddon22.vlocity_cmt__Product2Id__c = prod42.id;
                    qlimaddon22.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod4.id+'<'+prod42.Id;
                    qlimaddon22.vlocity_cmt__RootItemId__c = qliMbundle.Id;
                    qlimaddon22.UnitPrice = 0;
                    qlimaddon22.Quantity = 1;
                qlilist1.add(qlimaddon22);
                insert qlilist1;
//--------------------------------------------------------------------------------------------------------------------------------------------------------
                Quote oldqut2 = new Quote();
                    oldqut2.Name='Test Quote';
                    oldqut2.status = 'Draft';
                    oldqut2.opportunityId = opp.id;
                    oldqut2.Pricebook2ID = stdPriceBookRecId;
                    oldqut2.TeliaSE_Approval_Flag__c = False;
                insert oldqut2; 
                
                List<QuoteLineItem> qlilist2 = new List<QuoteLineItem>();
            
                QuoteLineItem qlisbundle = new QuoteLineItem();
                    qlisbundle.PricebookEntryId = objpricebookentry1.Id;
                    qlisbundle.QuoteId = oldqut2.id;
                    qlisbundle.Product2Id = prod1.id;
                    qlisbundle.vlocity_cmt__Product2Id__c = prod1.id;
                    qlisbundle.vlocity_cmt__ProductHierarchyPath__c = prod1.id;
                    qlisbundle.vlocity_cmt__RootItemId__c = prod1.id;
                    qlisbundle.UnitPrice = 0;
                    qlisbundle.Quantity = 1;
                insert qlisbundle;
                    qlisbundle.vlocity_cmt__RootItemId__c = qlisbundle.Id;
                update qlisbundle;
                // all in plus -- bas
                QuoteLineItem qlisbas = new QuoteLineItem();
                    qlisbas.PricebookEntryId = objpricebookentry1.Id;
                    qlisbas.QuoteId = oldqut2.id;
                    qlisbas.Product2Id = prod2.id;
                    qlisbas.vlocity_cmt__Product2Id__c = prod2.id;
                    qlisbas.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod2.id;
                    qlisbas.vlocity_cmt__RootItemId__c = qlisbundle.Id;
                    qlisbas.UnitPrice = 0;
                    qlisbas.Quantity = 1;
                qlilist2.add(qlisbas);
                QuotelineItem qlisbasaddon1 = new QuoteLineItem();
                    qlisbasaddon1.PricebookEntryId = objpricebookentry1.Id;
                    qlisbasaddon1.QuoteId = oldqut2.id;
                    qlisbasaddon1.Product2Id = prod21.id;
                    qlisbasaddon1.vlocity_cmt__Product2Id__c = prod21.id;
                    qlisbasaddon1.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod2.id+'<'+prod21.id;
                    qlisbasaddon1.vlocity_cmt__RootItemId__c = qlisbundle.Id;
                    qlisbasaddon1.UnitPrice = 0;
                    qlisbasaddon1.Quantity = 1;
                qlilist2.add(qlisbasaddon1);
                QuotelineItem qlisbasaddon2 = new QuoteLineItem();
                    qlisbasaddon2.PricebookEntryId = objpricebookentry1.Id;
                    qlisbasaddon2.QuoteId = oldqut2.id;
                    qlisbasaddon2.Product2Id = prod22.id;
                    qlisbasaddon2.vlocity_cmt__Product2Id__c = prod22.id;
                    qlisbasaddon2.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod2.id+'<'+prod22.id;
                    qlisbasaddon2.vlocity_cmt__RootItemId__c = qlisbundle.Id;
                    qlisbasaddon2.UnitPrice = 0;
                    qlisbasaddon2.Quantity = 1;
                qlilist2.add(qlisbasaddon2);
                // all in plus -- 1gb
                QuotelineItem qlis1gb = new QuoteLineItem();
                    qlis1gb.PricebookEntryId = objpricebookentry1.Id;
                    qlis1gb.QuoteId = oldqut2.id;
                    qlis1gb.Product2Id = prod7.id;
                    qlis1gb.vlocity_cmt__Product2Id__c = prod7.id;
                    qlis1gb.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod7.id;
                    qlis1gb.vlocity_cmt__RootItemId__c = qlisbundle.Id;
                    qlis1gb.UnitPrice = 0;
                    qlis1gb.Quantity = 1;
                qlilist2.add(qlis1gb);
                // all in plus -- 2gb
                QuotelineItem qlis2gb = new QuoteLineItem();
                    qlis2gb.PricebookEntryId = objpricebookentry1.Id;
                    qlis2gb.QuoteId = oldqut2.id;
                    qlis2gb.Product2Id = prod8.id;
                    qlis2gb.vlocity_cmt__Product2Id__c = prod8.id;
                    qlis2gb.vlocity_cmt__ProductHierarchyPath__c = prod1.id+'<'+prod8.id;
                    qlis2gb.vlocity_cmt__RootItemId__c = qlisbundle.Id;
                    qlis2gb.UnitPrice = 0;
                    qlis2gb.Quantity = 1;
                qlilist2.add(qlis2gb);
                insert qlilist2;
                //insurance
                QuoteLineItem qlisinsurace = new QuoteLineItem();
                    qlisinsurace.PricebookEntryId = objpricebookentry1.Id;
                    qlisinsurace.QuoteId = oldqut2.id;
                    qlisinsurace.Product2Id = prod3.id;
                    qlisinsurace.vlocity_cmt__Product2Id__c = prod3.id;
                    qlisinsurace.vlocity_cmt__ProductHierarchyPath__c = prod3.id;
                    qlisinsurace.UnitPrice = 0;
                    qlisinsurace.Quantity = 1;
                insert qlisinsurace;
                    qlisinsurace.vlocity_cmt__RootItemId__c = qlisinsurace.Id;
                update qlisinsurace;
//--------------------------------------------------------------------------------------------------------------------------------------------------------
                List<QuoteLineItem> getparentrootId = new List<QuoteLineItem>([select id,vlocity_cmt__Product2Id__c from QuoteLineItem where quoteid=: masterQuote.id]);
                System.debug('getparentrootId'+getparentrootId); 
                System.debug('pr'+pr);
                Map<String,Object> inputMap = new Map<String,Object>();
                inputMap.put('ContextId',oldqut.Id);
                Map<String,Object> outMap = new Map<String,Object>();
                Map<String,Object> outMap1 = new Map<String,Object>();
                Map<String,Object> outMap2 = new Map<String,Object>();
                Map<String,Object> optionsMap = new Map<String,Object>();
                outMap.put('mquid',masterQuote.id);
                SingleCart_QuoteBackup1 singleqb = new SingleCart_QuoteBackup1();
                
            //---------------------for cancelled -------------------------
                Map<String,Object> inputMap1 = new Map<String,Object>();
                inputMap1.put('ContextId',oldqut1.Id);
                singleqb.invokeMethod('level1',inputMap1,outMap1,optionsMap);
            //------------------------------------------------------------
                
                singleqb.invokeMethod('level1',inputMap,outMap,optionsMap);
                outMap.put('ContextId',oldqut2.Id);            
                singleqb.invokeMethod('level2',outMap,outMap2,optionsMap);
                singleqb.invokeMethod('revertQuote',outMap,outMap2,optionsMap);
                //addon
                singleqb.invokeMethod('addon',outMap,outMap,optionsMap);
                outMap.put('ContextId',masterQuote.id);
                singleqb.invokeMethod('updateFields',outMap,outMap2,optionsMap);
           //----------------------for exceptions-------------------------------
                singleqb.invokeMethod('',inputMap1,outMap1,optionsMap);
                inputMap1.put('ContextId','112345567');
                singleqb.invokeMethod('level1',inputMap1,outMap1,optionsMap);
                singleqb.invokeMethod('level2',inputMap1,outMap1,optionsMap);
                singleqb.invokeMethod('revertQuote',inputMap1,outMap1,optionsMap);
                singleqb.invokeMethod('addon',inputMap1,outMap1,optionsMap);
                singleqb.invokeMethod('updateFields',inputMap1,outMap1,optionsMap);
           //

            Test.stopTest();
        }
 }
}